<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Orchestration Frontend</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <h1>LLM Orchestration Frontend</h1>
    
    <div class="container">
        <div class="chat-container">
            <h2>Chat Interface</h2>
            <div id="chat-history" class="chat-history"></div>
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Enter your message..." />
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
        
        <div class="status-container">
            <h2>System Status</h2>
            <div id="system-status">
                <p>Loading system status...</p>
            </div>
            
            <h3>System Parameters</h3>
            <div id="system-parameters">
                <p>Loading system parameters...</p>
            </div>
            
            <h3>Loaded Agents</h3>
            <div id="loaded-agents">
                <p>Loading agents...</p>
            </div>
        </div>
    </div>

    <script>
        marked.setOptions({
            gfm: true,
            breaks: true,
            smartypants: true
        });
        
        let conversationHistory = [];
        
        async function fetchSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const statusData = await response.json();
                
                document.getElementById('system-status').innerHTML = 
                    '<p><strong>Status:</strong> ' + statusData.system_status + '</p>';
                
                const agentsList = statusData.agents.map(agent => '<li>' + agent + '</li>').join('');
                document.getElementById('loaded-agents').innerHTML = 
                    '<ul>' + agentsList + '</ul>';
                
                if (statusData.system_parameters && Object.keys(statusData.system_parameters).length > 0) {
                    let parametersHtml = '';
                    for (const [key, value] of Object.entries(statusData.system_parameters)) {
                        parametersHtml += 
                            '<div class=\"parameter-item\">' +
                                '<span class=\"parameter-name\">' + key + ':</span>' +
                                '<span class=\"parameter-value\">' + value + '</span>' +
                            '</div>';
                    }
                    document.getElementById('system-parameters').innerHTML = parametersHtml;
                } else {
                    document.getElementById('system-parameters').innerHTML = '<p>No system parameters available</p>';
                }
            } catch (error) {
                console.error('Error fetching system status:', error);
                document.getElementById('system-status').innerHTML = '<p>Error loading system status</p>';
            }
        }
        
        async function sendMessage() {
            const inputElement = document.getElementById('user-input');
            const message = inputElement.value.trim();
            
            if (!message) return;
            
            addMessageToChat('user', message);
            inputElement.value = '';
            
            try {
                const chatHistory = document.getElementById('chat-history');
                
                const response = await fetch('/api/stream_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                });
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.slice(6);
                            if (jsonStr.trim() === '[DONE]') {
                                break;
                            }
                            
                            try {
                                const event = JSON.parse(jsonStr);
                                
                                switch (event.type) {
                                    case 'tool_call':
                                        addToolCallToChat(event.data);
                                        break;
                                        
                                    case 'tool_response':
                                        addToolResponseToChat(event.data);
                                        break;
                                        
                                    case 'suggested_agents':
                                        addSuggestedAgentsToChat(event.data);
                                        break;
                                        
                                    case 'assistant_response':
                                        assistantMessage += event.content;
                                        // Create or update the assistant response div after tool-related messages
                                        let responseDiv = document.querySelector('.temp-assistant-response');
                                        if (!responseDiv) {
                                            responseDiv = document.createElement('div');
                                            responseDiv.className = 'message assistant-message temp-assistant-response';
                                            chatHistory.appendChild(responseDiv);
                                        }
                                        // Add a placeholder for token counts
                                        let responseWithTokens = marked.parse(assistantMessage);
                                        responseWithTokens += '<div class="token-counts-placeholder" style="font-size: 0.8em; color: #666; margin-top: 5px; padding: 5px; border-top: 1px solid #eee;"><em>Calculating token usage...</em></div>';
                                        responseDiv.innerHTML = responseWithTokens;
                                        chatHistory.scrollTop = chatHistory.scrollHeight;
                                        break;
                                        
                                    case 'token_counts':
                                        // Update token count information in the assistant response
                                        const tokenPlaceholder = document.querySelector('.token-counts-placeholder');
                                        if (tokenPlaceholder) {
                                            tokenPlaceholder.innerHTML = `<strong>Token Usage:</strong> Input: ${event.data.input_tokens}, Output: ${event.data.output_tokens}, Total: ${event.data.total_tokens}`;
                                            tokenPlaceholder.className = 'token-counts';
                                        } else {
                                            // If no placeholder, add token count information to the assistant response
                                            const tokenInfo = document.createElement('div');
                                            tokenInfo.className = 'token-counts';
                                            tokenInfo.style.fontSize = '0.8em';
                                            tokenInfo.style.color = '#666';
                                            tokenInfo.style.marginTop = '5px';
                                            tokenInfo.style.padding = '5px';
                                            tokenInfo.style.borderTop = '1px solid #eee';
                                            tokenInfo.innerHTML = `<strong>Token Usage:</strong> Input: ${event.data.input_tokens}, Output: ${event.data.output_tokens}, Total: ${event.data.total_tokens}`;
                                            
                                            // Add to the assistant response div
                                            let tokenDiv = document.querySelector('.temp-assistant-response');
                                            if (!tokenDiv) {
                                                tokenDiv = document.querySelector('.assistant-message:not(.temp-assistant-response)');
                                            }
                                            if (tokenDiv) {
                                                tokenDiv.appendChild(tokenInfo);
                                            }
                                        }
                                        break;
                                        
                                    case 'final_response':
                                        // Update conversation history from final response
                                        conversationHistory = event.data.conversation_history;
                                        // Remove the temporary class and finalize the assistant message
                                        const finalResponseDiv = document.querySelector('.temp-assistant-response');
                                        if (finalResponseDiv) {
                                            finalResponseDiv.classList.remove('temp-assistant-response');
                                        }
                                        break;
                                }
                            } catch (e) {
                                console.error('Error parsing SSE event:', e);
                            }
                        }
                    }
                }
                
                // Ensure the final response is completely displayed but preserve token counts if they exist
                if (assistantMessage) {
                    const finalResponseDiv = document.querySelector('.assistant-message:not(.temp-assistant-response), .temp-assistant-response');
                    if (finalResponseDiv) {
                        // Save token counts element if it exists
                        const tokenCountsDiv = finalResponseDiv.querySelector('.token-counts');
                        
                        // Update the response content
                        finalResponseDiv.innerHTML = marked.parse(assistantMessage);
                        
                        // If token counts existed, add them back
                        if (tokenCountsDiv) {
                            finalResponseDiv.appendChild(tokenCountsDiv);
                        }
                        
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    }
                } else {
                    // If no assistant message was streamed, add a final message
                    addMessageToChat('assistant', 'Processing complete.');
                }
                
                await fetchSystemStatus();
            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('assistant', 'Error: Failed to process your message');
            }
        }
        
        function addMessageToChat(role, content) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role + '-message';
            
            messageDiv.innerHTML = marked.parse(content);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        function addToolCallToChat(toolCall) {
            const chatHistory = document.getElementById('chat-history');
            const toolCallDiv = document.createElement('div');
            toolCallDiv.classList.add('message', 'tool-call-message');
            
            let toolCallContent = '<div class="tool-call-header">ðŸ”§ Tool Call: ' + toolCall.agent_name + '.' + toolCall.method_name + '</div>';
            
            if (toolCall.parameters && Object.keys(toolCall.parameters).length > 0) {
                toolCallContent += '<div class="tool-call-parameters"><strong>Parameters:</strong> ' + JSON.stringify(toolCall.parameters) + '</div>';
            }
            
            // Add token counts if available
            if (toolCall.token_counts) {
                toolCallContent += '<div class="tool-call-token-counts" style="font-size: 0.8em; color: #666; margin-top: 5px; padding: 5px; border-top: 1px solid #eee;">';
                toolCallContent += '<strong>Token Usage:</strong> Input: ' + toolCall.token_counts.input_tokens + ', Output: ' + toolCall.token_counts.output_tokens + ', Total: ' + toolCall.token_counts.total_tokens;
                toolCallContent += '</div>';
            }
            
            toolCallDiv.innerHTML = toolCallContent;
            chatHistory.appendChild(toolCallDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        function addToolResponseToChat(toolCall) {
            const chatHistory = document.getElementById('chat-history');
            const toolResponseDiv = document.createElement('div');
            toolResponseDiv.classList.add('message', 'tool-response-message');
            
            let toolResponseContent = '<div class="tool-response-header">âœ… Tool Response: ' + toolCall.agent_name + '.' + toolCall.method_name + '</div>';
            
            if (toolCall.result) {
                if (toolCall.result.error) {
                    toolResponseContent += '<div class="tool-response-error"><strong>Error:</strong> ' + toolCall.result.error + '</div>';
                } else {
                    toolResponseContent += '<div class="tool-response-result"><strong>Result:</strong> ' + JSON.stringify(toolCall.result) + '</div>';
                }
            }
            
            // Add token counts if available
            if (toolCall.token_counts) {
                toolResponseContent += '<div class="tool-response-token-counts" style="font-size: 0.8em; color: #666; margin-top: 5px; padding: 5px; border-top: 1px solid #eee;">';
                toolResponseContent += '<strong>Token Usage:</strong> Input: ' + toolCall.token_counts.input_tokens + ', Output: ' + toolCall.token_counts.output_tokens + ', Total: ' + toolCall.token_counts.total_tokens;
                toolResponseContent += '</div>';
            }
            
            toolResponseDiv.innerHTML = toolResponseContent;
            chatHistory.appendChild(toolResponseDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        function addSuggestedAgentsToChat(suggestedAgents) {
            const chatHistory = document.getElementById('chat-history');
            const suggestedAgentsDiv = document.createElement('div');
            suggestedAgentsDiv.classList.add('message', 'suggested-agents-message');
            
            let suggestedAgentsContent = '<div class=\"suggested-agents-header\">ðŸ’¡ Suggested Agents:</div>';
            
            suggestedAgents.forEach(agent => {
                suggestedAgentsContent += '<div class=\"suggested-agent\">';
                suggestedAgentsContent += '<div class=\"suggested-agent-name\"><strong>' + agent.name + '</strong></div>';
                suggestedAgentsContent += '<div class=\"suggested-agent-description\">' + agent.description + '</div>';
                if (agent.capabilities && agent.capabilities.length > 0) {
                    suggestedAgentsContent += '<div class=\"suggested-agent-capabilities\"><strong>Capabilities:</strong> ' + agent.capabilities.join(', ') + '</div>';
                }
                suggestedAgentsContent += '</div>';
            });
            
            suggestedAgentsDiv.innerHTML = suggestedAgentsContent;
            chatHistory.appendChild(suggestedAgentsDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('user-input').addEventListener('keypress', handleKeyPress);
            
            fetchSystemStatus();
            
            addMessageToChat('assistant', 'Welcome to the LLM Orchestration System! How can I help you today?');
        });
    </script>
</body>
</html>